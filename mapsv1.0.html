<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>country's publication'</title>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<style>
			body {
				font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
				width: 1200px;
				height: 900px;
				position: relative;
			}
			path {
			  stroke: white;
			  stroke-width: 0.25px;
			  fill: grey;
			}
			.land {
			  fill: #222;
			}

			.boundary {
			  fill: none;
			  stroke: #fff;
			  stroke-width: 1px;
			}
			#tooltip-container {
			  position: absolute;
			  background-color: #fff;
			  color: #000;
			  padding: 10px;
			  border: 1px solid;
			  display: none;
			}

			.tooltip_key {
			  font-weight: bold;
			}

			.tooltip_value {
			  margin-left: 20px;
			  float: right;
			}
			
		</style>
	</head>
	<body>
		<div id="tooltip-container"></div>
		<table width="100%" border="0">
			<tr>
				<td colspan="3" bgcolor="#b5dcb3">
					<div class = "sourceSet" style="display:inline">
						<div style="font-size: 16px; display:inline;">Source</div>
						<div style=" display:inline;" >
							<select id = "sourceselect"> </select>
				 		</div>
					</div>
				</td>
	     	</tr>
			<tr valign="top">
				<td bgcolor="#aaa" width="25%">
		      
		    	</td>
		    	<td bgcolor="#b5dcb3" height="800" width="50%">
					<div id = "geomap" style="margin-top: 0px; margin-bottom: 15px; border: 2px solid black">
				
					</div>
		   	 	</td>
		    	<td bgcolor="#aaa" width="25%">
		     
		    	</td>
			</tr>
		</table>  
		
		<script type="text/javascript"> 
			var filepath = "dataset/itsec"
			var sselect=d3.select("#sourceselect");
			var soptions=sselect.selectAll('option').data(["IEEE intelligent tranporationsystem", "IEEE Transactions on Evolutionary Computation", "IEEE ITS conference"])
				.enter().append('option').text(function(d){
					return d;
				}).property("selected", function(d){ return d == "IEEE Transactions on Evolutionary Computation"; });
			sselect.on("change",function(){
				var sstr= d3.select('#sourceselect').node().value;
				if(sstr == "IEEE intelligent tranporationsystem"){
					filepath =  "dataset/its2"
					reset();
				}
				else if(sstr == "IEEE Transactions on Evolutionary Computation"){
					filepath =  "dataset/itsec"
					reset();
				}
				else {
					filepath =  "dataset/itsconf"
					reset();
				}
			});
			
			initial()
			function reset(){
				d3.selectAll('svg > *').remove();
				initial();
			}
			var COLOR_COUNTS = 9;
		    function Color(_r, _g, _b) {
		        var r, g, b;
		        var setColors = function(_r, _g, _b) {
		            r = _r;
		            g = _g;
		            b = _b;
		        };
  
		        setColors(_r, _g, _b);
		        this.getColors = function() {
		            var colors = {
		                r: r,
		                g: g,
		                b: b
		            };
		            return colors;
		        };
		    }
		    function hexToRgb(hex) {
		        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		        return result ? {
		            r: parseInt(result[1], 16),
		            g: parseInt(result[2], 16),
		            b: parseInt(result[3], 16)
		        } : null;
		    }
		    function Interpolate(start, end, steps, count) {
		        var s = start,
		            e = end,
		            final = s + (((e - s) / steps) * count);
		        return Math.floor(final);
		    }
		    var COLOR_FIRST = "#99ccff", COLOR_LAST = "#0050A1";
  
		    var rgb = hexToRgb(COLOR_FIRST);
  
		    var COLOR_START = new Color(rgb.r, rgb.g, rgb.b);
  
		    rgb = hexToRgb(COLOR_LAST);
		    var COLOR_END = new Color(rgb.r, rgb.g, rgb.b);
  
		    var startColors = COLOR_START.getColors(),
		        endColors = COLOR_END.getColors();
  
		    var colors = [];
  
		    for (var i = 0; i < COLOR_COUNTS; i++) {
		    	var r = Interpolate(startColors.r, endColors.r, COLOR_COUNTS, i);
		    	var g = Interpolate(startColors.g, endColors.g, COLOR_COUNTS, i);
		    	var b = Interpolate(startColors.b, endColors.b, COLOR_COUNTS, i);
		   	 	colors.push(new Color(r, g, b));
		    }
			var width = 600, height = 400;
	    	var projection = d3.geo.mercator()
	        	.scale((width + 1) / 2 / Math.PI)
	        	.translate([width / 2, height / 2])
	        	.precision(.1);
	    	var path = d3.geo.path()
	        	.projection(projection);
			var graticule = d3.geo.graticule();
	    	var quantize = d3.scale.quantize()
	        	.range(d3.range(COLOR_COUNTS).map(function(i) { return i }));  
			function initial(){
				var width = 600, height = 400;
	    		var svg = d3.select("#geomap").append("svg")
	        		.attr("width", width)
	        		.attr("height", height);
	    		var graticule = d3.geo.graticule();
				
				d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, world) {
					var g = svg.append("g");
					//grids
			    	g.append("path")
			        	.datum(graticule)
			        	.attr("class", "graticule")
						.attr("class", "choropleth")
			        	.attr("d", path);
					g.append("path")
				        .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
				        .attr("class", "equator")
				        .attr("d", path);
				    g.append("path")
				        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
				        .attr("class", "boundary")
				        .attr("d", path);
						
					var countries = topojson.feature(world, world.objects.countries).features;
					var country = g.selectAll(".country").data(countries);
					
					d3.csv(filepath+"_countrytest.csv", function(error, mycontry) {
						if (error) throw error;
						else{
							var valueHash = {};
						    var MAP_KEY = "country";
						    var MAP_VALUE = "publication";
						    mycontry.forEach(function(d) {
						    	valueHash[d[MAP_KEY]] = +d[MAP_VALUE];
						    });
						    quantize.domain([d3.min(mycontry, function(d){
						        return (+d[MAP_VALUE]) }),
						      d3.max(mycontry, function(d){
						        return (+d[MAP_VALUE]) })]);
						    country.enter().insert("path")
						        .attr("class", "country")
						        .attr("d", path)
						        .attr("id", function(d,i) { return d.id; })
						        .attr("title", function(d) { return d.properties.name; })
						        .style("fill", function(d) {
						          if (valueHash[d.properties.name]) {
						            var c = quantize((valueHash[d.properties.name]));
						            var color = colors[c].getColors();
						            return "rgb(" + color.r + "," + color.g +
						                "," + color.b + ")";
						          } else {
						            return "#ccc";
						          }
						        })
						        .on("mousemove", function(d) {
						            var html = "";
						            html += "<div class=\"tooltip_kv\">";
						            html += "<span class=\"tooltip_key\">";
						            html += d.properties.name;
						            html += "</span>";
						            html += "<span class=\"tooltip_value\">";
						            html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
						            html += "";
						            html += "</span>";
						            html += "</div>";
						            $("#tooltip-container").html(html);
						            $(this).attr("fill-opacity", "0.8");
						            $("#tooltip-container").show();
            
						            var coordinates = d3.mouse(this);
            
						            var map_width = $('.choropleth')[0].getBoundingClientRect().width;
            
						            if (d3.event.pageX < map_width / 2) {
						              d3.select("#tooltip-container")
						                .style("top", (d3.event.layerY + 15) + "px")
						                .style("left", (d3.event.layerX + 15) + "px");
						            } else {
						              var tooltip_width = $("#tooltip-container").width();
						              d3.select("#tooltip-container")
						                .style("top", (d3.event.layerY + 15) + "px")
						                .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
						            }
						        })
						        .on("mouseout", function() {
						                $(this).attr("fill-opacity", "1.0");
						                $("#tooltip-container").hide();
						            });
						}

					});
				});
				// zoom and pan
				// var zoom = d3.behavior.zoom()
// 	    			.on("zoom",function() {
// 	        	g.attr("transform","translate("+
// 	            	d3.event.translate.join(",")+")scale("+d3.event.scale+")");
// 	        		g.selectAll("path")
// 	            		.attr("d", path.projection(projection));
// 				});

			// svg.call(zoom);
//
			
			// China;
//
// 1367470000
// 10/24/2014
// 19%
// Official population clock

				// d3.queue().defer(d3.json, "").await(ready);
				
			}
		</script>
	</body>
</html>